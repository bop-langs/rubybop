load '../bop_test.rake'

if RUBY_PLATFORM.include?("darwin")
  $cflags = $cflags + " -D__MACH__"
end

# To add stack size
# $ldflags = '-lm -Wl,-stack_size -Wl,80000000'

FileList.new('*.c').each do |source|
  bop_test source.ext, source, false
end

task :test => :force do
  require 'timeout'

  def run_test( test )
    print "\t#{test}: "
    begin
      Timeout.timeout(10) do
        output = %x["./#{test}"]
        ok = output.include?("The tests end")
        puts ok ? 'passed' : 'failed'
        return ok
      end
    rescue Timeout::Error => e
      puts 'timeout'
      return false
    end
  end

  puts "Running #{$progs.size} tests:"
  failed = $progs.inject( [] ) do |f, t|
    passed = run_test( t )
    f << t unless passed
    f
  end

  if failed.size == 0
    puts "all passed"
  else
    puts "Failed test(s): #{failed * ', '}"
  end
end
