task :default => :ruby

task :ruby => :bop do
  #build ruby
  cd "ruby" do
  	sh 'rm -f miniruby core*'
    if (!File.exists?("Makefile")) then
      sh 'autoconf'
      sh './configure'
    end
    sh 'make'
  end
end

task :bop do
  #build bop
  cd "bop" do
    sh 'make'
  end
end
task :boptest => :bop do
  cd "tests" do
    sh 'make test'
  end
end

task :test do
  cd "tests" do
    sh 'make test'
  end
  cd "ruby" do
		sh 'make test' do |ok, res|
			if ! ok then
				fail "Ruby tests failed with exit code = #{res.exitstatus}"
			end
		end
	end
end

task :nuke do
	sh 'git clean -xfd'
end
task :clean do
	cd "ruby" do
		if(File.exists?("Makefile")) then
			sh 'make clean'
		end
	end
  cd "bop" do
    sh 'make clean'
  end
  cd "tests/add" do
    sh 'rake clean'
  end
  cd "tests/sleep" do
    sh 'rake clean'
  end
  cd "tests/str" do
    sh 'rake clean'
  end
end
task :again do
	Rake::Task[:clean].invoke
	Rake::Task[:default].invoke
end
